<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <style>
        input {
            width: 90%;
        }
        #map {
            height: 600px;
            width: 800px;
        }
    </style>
    <h1>IMPEIA Books</h1>
    

    <h2>Listado de Libros</h2>

    <p>Al dar clic en la bandera, iras al país en el mapa. Deja el cursor sobre la ubicación y conoce cuántos libros hay disponibles!</p>

    <table>
        <thead>
            <tr>
                <th>Título</th>
                <th>Autor</th>
                <th>Editorial</th>
                <th>Género</th>
                <th>Ubicación Editorial</th>
                <th>Precio (usd)</th>
                <th>Cantidad disponible</th>

            </tr>
            <tr>
                <td><input type="text" id="filtro_titulo"></td>
                <td><input type="text" id="filtro_autor_nombre"></td>
                <td><input type="text" id="filtro_nombre_editorial"></td>
                <td><input type="text" id="filtro_autor_genero"></td>
                <td><input type="text" id="filtro_ubicacion_editorial"></td>
                <td><input type="text" id="filtro_precio"></td>
                <td><input type="text" id="filtro_disponibles"></td>

            </tr>
        </thead>
        <tbody  id="tabla_body">
            {% for row in rows %}
            <tr>
                <td>{{ row.titulo }}</td>
                <td>{{ row.autor_nombre }}</td>
                <td>{{ row.nombre_editorial }}</td>
                <td>{{ row.autor_genero }}</td>
                <td class="country" data-location="{{ row['coordenadas_editorial'] }}" data-quantity="{{ row['cantidad_stock'] }}"><img src="{{ row['codigo_pais'] }}" alt="{{ row['pais'] }}">{{ row.ubicacion_editorial }}</td>
                <td>{{ row.precio|format_currency }}</td>
                <td>{{ row.cantidad_stock }}</td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <h2>Mapa de editoriales</h2>
    <div id="map"></div>

        <!-- prettier-ignore -->
        <script>(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
        ({key: "{{ GOOGLE_MAPS_API_KEY }}", v: "weekly"});</script>
        <script>
            let map;

            async function initMap() {
              //@ts-ignore
              const { Map } = await google.maps.importLibrary("maps");
            
              map = new Map(document.getElementById("map"), {
                center: { lat: 40.5709, lng: -14.2973},
                zoom: 2,
              });

              var markers = [];

              {% for row in editoriales %}
                var coordenadas = "{{ row['coordenadas_editorial'].replace('[', '').replace(']', '') }}".split(',');
                var quantity = parseInt({{ row['cantidad_stock'] }}); 

                var marker = new google.maps.Marker({
                  position: {lat: parseFloat(coordenadas[0]), lng: parseFloat(coordenadas[1])},
                  map: map,
                  title: 'Cantidad de Libros: ' + {{ row['total_libros'] }}
                });
                markers.push(marker);
                console.log('Coordenadas:', coordenadas);
              {% endfor %}
              // Agregar evento click a los nombres de país en la tabla
              var countryNames = document.querySelectorAll('.country');
              countryNames.forEach(function(country, index) {
                country.addEventListener('click', function() {
                    var location = country.getAttribute('data-location');
                    var coordenadas = ((location.replace('[', '')).replace(']', '')).split(',');
                    console.log('Estas son las coordenadas: ' + coordenadas)
                    var lat = parseFloat(coordenadas[0]);
                    var lng = parseFloat(coordenadas[1]);
                    map.setZoom(4); // Establecer el nivel de zoom deseado
                    map.panTo({lat: lat, lng: lng}); // Centrar el mapa en el país
                    var quantity = parseInt(country.getAttribute('data-quantity'));
                    console.log('Cantidad de libros para ' + country.textContent + ': ' + quantity);

                });
              });
            }
            
            initMap();
        </script>
    </div>

    <!-- Análisis relevantes -->
    <h2>Análisis de datos</h2>
    <p>El autor quién primero llego a este planeta a regalarnos sus obras fue: <strong>{{autor_mayor_edad[0]}}</strong>. El autor quién esperó a lo último para llegar, y también nos dejó su excelentes obras fue: <strong>{{autor_menor_edad[0]}}</strong>. Ahora, si quieres leer una de estas obras literarias, y conocer las obras de estos autores o de quienes nacieron en medio, debes invertir en tí mínimamente <strong>USD {{ valores_libros[1] }}</strong>. Además, si te quieres mucho y tienes la capacidad de invertir en ti hasta <strong>USD {{ valores_libros[2] }}</strong>, ¡puedes adquirir cualquiera!. <i><u>Anímate a alimentar tu mente</u></i>; mira las cantidades que quedan para que puedas comprar alguna. Recuerda, en promedio debes invertir <strong>USD {{ valores_libros[0] }}</strong> para que no dejes de disfrutar de estas maravillosas obras:</p>

    <p> </p>

    <!-- Div para el gráfico -->
    <div id="grafico" style="width: 800px; height: 600px;"></div>

    <script>
        var graficoDict = {{ grafico_dict|tojson }};

        // Renderizar el gráfico en el div con ID "grafico"
        Plotly.newPlot('grafico', graficoDict.data, graficoDict.layout);
        console.log("Datos del gráfico:", graficoDict.data);
        console.log("Diseño del gráfico:", graficoDict.layout);
    </script>

    <script>
        // Obtener elementos de entrada de texto
        var inputTitulo = document.getElementById("filtro_titulo");
        var inputAutor = document.getElementById("filtro_autor_nombre");
        var inputEditorial = document.getElementById("filtro_nombre_editorial");
        var inputGenero = document.getElementById("filtro_autor_genero");
        var inputUbicacion = document.getElementById("filtro_ubicacion_editorial");
        var inputPrecio = document.getElementById("filtro_precio");
        var inputDisponibles = document.getElementById("filtro_disponibles");

        // Agregar un evento de cambio a cada campo de entrada de texto
        inputTitulo.addEventListener("input", filtrar);
        inputAutor.addEventListener("input", filtrar);
        inputEditorial.addEventListener("input", filtrar);
        inputGenero.addEventListener("input", filtrar);
        inputUbicacion.addEventListener("input", filtrar);
        inputPrecio.addEventListener("input", filtrar);
        inputDisponibles.addEventListener("input", filtrar);

        function filtrar() {
            var filtroTitulo = inputTitulo.value.toUpperCase();
            var filtroAutorNombre = inputAutor.value.toUpperCase();
            var filtroEditorial = inputEditorial.value.toUpperCase();
            var filtroAutorGenero = inputGenero.value.toUpperCase();
            var filtroUbicacion = inputUbicacion.value.toUpperCase();
            var filtroPrecio = inputPrecio.value.toUpperCase();
            var filtroDisponibles = inputDisponibles.value.toUpperCase();
            var tabla = document.getElementById("tabla_body");
            var filas = tabla.getElementsByTagName("tr");

            for (var i = 0; i < filas.length; i++) {
                var fila = filas[i];
                var titulo = fila.getElementsByTagName("td")[0].innerText.toUpperCase();
                var autor_nombre = fila.getElementsByTagName("td")[1].innerText.toUpperCase();
                var editorial = fila.getElementsByTagName("td")[2].innerText.toUpperCase();
                var genero = fila.getElementsByTagName("td")[3].innerText.toUpperCase();
                var ubicacion = fila.getElementsByTagName("td")[4].innerText.toUpperCase();
                var precio = fila.getElementsByTagName("td")[5].innerText.toUpperCase();
                var disponibles = fila.getElementsByTagName("td")[6].innerText.toUpperCase();


                if (titulo.includes(filtroTitulo) && autor_nombre.includes(filtroAutorNombre) && editorial.includes(filtroEditorial) && genero.includes(filtroAutorGenero) && ubicacion.includes(filtroUbicacion) && precio.includes(filtroPrecio) && disponibles.includes(filtroDisponibles)) {
                    fila.style.display = "";
                } else {
                    fila.style.display = "none";
                }
            }
        }
    </script>
</body>
</html>
